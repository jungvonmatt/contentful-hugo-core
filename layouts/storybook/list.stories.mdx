{{- define "main" -}}
{{- $parts := split .Page.SectionsPath "/" -}}
{{- $content_type := index (last 1 $parts) 0 -}}
{{- $category := partial "utils/get-category-name" (dict "content_type" $content_type) -}}
{{- $path := print $category "/" $content_type "/Docs"  -}}
{{- $add_docs := fileExists (print "docs/contentful/" $content_type ".md") -}}

{{- $filepath := .Page.File.Path }}


import dedent from 'ts-dedent';
import '@public/css/main.css';
import { Meta, Story, Canvas, Source } from '@storybook/addon-docs';
{{- if $add_docs }}
import ContentfulDocs from '@docs/{{ $content_type }}.md';
{{- end }}

<Meta title="{{ $path }}" />

{{/* Render variations of stories which have includeInDocs set */}}
# {{ $content_type }}
{{ $stories := (where .Pages "Params.includeInDocs" true) }}
{{ if gt (len $stories) 1 }}
## Variations
{{- end }}
{{ range $stories }}
{{ if gt (len $stories) 1 }}
### {{ .File.ContentBaseName }}
{{ end }}
<Canvas>
  <Story id="{{ $category }}-{{ $content_type }}-examples--{{.File.ContentBaseName}}" />
</Canvas>
{{- $source := "" -}}
{{ range $key, $partial := .Params.partials -}}
{{ $source = print $source "\n " (partial "utils/storybook/partial-source" (dict
  "globals" $
  "context" .
)) }}
{{- end }}
{{ with $source }}
<details>
  <summary>Show partial code</summary>
  <Source language="html" {{ (printf "code={dedent`%s`}" .) | safeHTMLAttr }} />
</details>
{{- end }}
{{- end }}

{{/* Render markdown body or autogenerated params table */}}
{{- with .Content }}
{{ . }}
{{ else -}}
{{ $args := partial "utils/storybook/partial-args" (dict
  "globals" $
  "context" (dict "content_type" $content_type)
) }}
{{ with $args }}
## Template params
| Name                        | Type     | Description  | Default |
| --------------------------- | -------- | ------------ | ------- |
{{ range $key, $val := . }} | {{$key}} | `{{ $val }}` |         |     |
{{ end }} {{/* Range end */}}
_This table can be customized by writing markdown in `content/{{ $filepath }}`._
{{- end -}}
{{- end -}}

{{ if $add_docs }}
## Contentful model

<ContentfulDocs />
{{- end -}}
{{- end -}}

